<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CINPS Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* --- Design System & Branding --- */
:root {
  --brand-primary: #0d3b8e;
  --brand-secondary: #1e5dd6;
  --accent: #f0b323;
  --success: #10b981;
  --danger: #e53935;
  --bg-color: #f4f7fb;
  --card-bg: #ffffff;
  --text-main: #1f2937;
  --text-muted: #6b7280;
  --border-color: #e5e7eb;
  --input-focus: rgba(13, 59, 142, 0.15);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
  --radius-md: 8px;
  --radius-lg: 12px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-main);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* --- Layout & Header --- */
header {
  background: linear-gradient(135deg, var(--brand-primary) 0%, #0a2a66 100%);
  color: #fff;
  padding: 16px 5%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-md);
  position: sticky;
  top: 0;
  z-index: 100;
}

header h2 { font-size: 1.25rem; font-weight: 600; }
.admin-info { font-size: 0.85rem; opacity: 0.9; margin-right: 15px; display: none; }

@media (min-width: 768px) {
  .admin-info { display: inline-block; }
}

/* --- Buttons --- */
button {
  cursor: pointer;
  border: none;
  border-radius: var(--radius-md);
  padding: 10px 16px;
  font-size: 0.875rem;
  font-weight: 500;
  font-family: inherit;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary { background: var(--brand-primary); color: #fff; }
.btn-primary:hover { background: var(--brand-secondary); transform: translateY(-1px); }
.btn-success { background: var(--success); color: #fff; padding: 6px 12px; font-size: 0.8rem; }
.btn-success:hover { filter: brightness(1.1); }
.btn-outline { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.3); }
.btn-outline:hover { background: var(--danger); border-color: var(--danger); }

/* --- Containers & Cards --- */
.container {
  width: 95%;
  max-width: 1400px;
  margin: 30px auto;
}

.card {
  background: var(--card-bg);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  padding: 24px;
  margin-bottom: 24px;
}

.card-header {
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border-color);
}

.card-header h3 { color: var(--brand-primary); font-size: 1.2rem; }

/* --- Forms & Inputs --- */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 16px;
}

.input-group { display: flex; flex-direction: column; gap: 6px; }
.input-group label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }

input {
  padding: 10px 12px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  font-family: inherit;
  font-size: 0.9rem;
  transition: border-color 0.2s, box-shadow 0.2s;
  width: 100%;
}

input:focus {
  outline: none;
  border-color: var(--brand-secondary);
  box-shadow: 0 0 0 3px var(--input-focus);
}

/* --- Data Table (Responsive Grid) --- */
.table-responsive {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

table {
  width: 100%;
  min-width: 900px;
  border-collapse: separate;
  border-spacing: 0;
  text-align: left;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid var(--border-color);
  font-size: 0.9rem;
}

th {
  background: #f9fafb;
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
}

/* Make table inputs look like seamless cells until focused */
td input {
  padding: 8px;
  border: 1px solid transparent;
  background: transparent;
  border-radius: 4px;
  width: 100%;
}

td input:hover { border-color: var(--border-color); background: #fff; }
td input:focus { border-color: var(--brand-secondary); background: #fff; }

.uid-cell { font-family: monospace; font-size: 0.8rem; color: var(--text-muted); }
.due-cell { font-weight: 600; color: var(--danger); }

/* --- Auth View --- */
.auth-view {
  min-height: 80vh;
  display: flex;
  justify-content: center;
  align-items: center;
}

.auth-card {
  max-width: 400px;
  width: 100%;
  text-align: center;
}

.google-icon { width: 18px; height: 18px; }

/* --- Toast Notifications --- */
#toastContainer {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 9999;
}

.toast {
  background: var(--text-main);
  color: #fff;
  padding: 12px 20px;
  border-radius: var(--radius-md);
  font-size: 0.9rem;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  transform: translateY(20px);
  animation: slideIn 0.3s forwards;
}

.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--danger); }

@keyframes slideIn {
  to { opacity: 1; transform: translateY(0); }
}

.hidden { display: none !important; }
</style>
</head>
<body>

<header>
  <h2>CINPS Admin Panel</h2>
  <div>
    <span id="adminInfo" class="admin-info"></span>
    <button id="logoutBtn" class="btn-outline hidden">Logout</button>
  </div>
</header>

<main class="container">
  
  <div id="authSection" class="auth-view">
    <div class="card auth-card">
      <h3 style="color:var(--brand-primary); margin-bottom:10px;">Admin Login</h3>
      <p style="color:var(--text-muted); margin-bottom:20px; font-size:0.9rem;">Secure access for authorized personnel only.</p>
      <button id="loginBtn" class="btn-primary" style="width:100%;">
        <svg class="google-icon" viewBox="0 0 24 24"><path fill="#fff" d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z"/></svg>
        Sign in with Google
      </button>
    </div>
  </div>

  <div id="adminArea" class="hidden">
    
    <div class="card">
      <div class="card-header">
        <h3>Create New Student Profile</h3>
      </div>
      <div class="form-grid">
        <div class="input-group">
          <label>Student UID (Firebase Auth)</label>
          <input id="newUid" placeholder="e.g. jX9sK..." />
        </div>
        <div class="input-group">
          <label>Full Name</label>
          <input id="newName" placeholder="John Doe" />
        </div>
        <div class="input-group">
          <label>Email Address</label>
          <input id="newEmail" type="email" placeholder="student@cinps.edu" />
        </div>
        <div class="input-group">
          <label>Course</label>
          <input id="newCourse" placeholder="B.Sc Nursing" />
        </div>
        <div class="input-group">
          <label>Branch</label>
          <input id="newBranch" placeholder="Main Campus" />
        </div>
        <div class="input-group">
          <label>Total Fee Applicable (â‚¹)</label>
          <input id="newFee" type="number" placeholder="50000" min="0" />
        </div>
      </div>
      <button id="addStudentBtn" class="btn-primary">Create Student Record</button>
    </div>

    <div class="card">
      <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Manage Students</h3>
        <button id="refreshBtn" class="btn-outline" style="color:var(--brand-primary); border-color:var(--brand-primary);">Refresh Data</button>
      </div>
      <div class="table-responsive">
        <table id="studentsTable">
          <thead>
            <tr>
              <th>Auth UID</th>
              <th>Student Name</th>
              <th>Course</th>
              <th>Branch</th>
              <th>Attendance (%)</th>
              <th>Total Fee (â‚¹)</th>
              <th>Fee Paid (â‚¹)</th>
              <th>Fee Due (â‚¹)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            </tbody>
        </table>
      </div>
    </div>

  </div>
</main>

<div id="toastContainer"></div>

<script type="module">
// ===== FIREBASE IMPORTS =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ðŸ” PASTE YOUR REAL KEYS HERE */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "cinps-student-corner.firebaseapp.com",
  projectId: "cinps-student-corner",
  storageBucket: "cinps-student-corner.firebasestorage.app",
  messagingSenderId: "YOUR_MESSAGING_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const provider = new GoogleAuthProvider();

// ===== UI ELEMENTS =====
const authSection = document.getElementById("authSection");
const adminArea = document.getElementById("adminArea");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const adminInfo = document.getElementById("adminInfo");
const tableBody = document.getElementById("tableBody");
const addStudentBtn = document.getElementById("addStudentBtn");
const refreshBtn = document.getElementById("refreshBtn");
const toastContainer = document.getElementById("toastContainer");

// ===== UTILITIES =====
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerText = message;
  toastContainer.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ===== AUTHENTICATION =====
loginBtn.onclick = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (error) {
    showToast("Login cancelled or failed.", "error");
  }
};

logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    authSection.classList.remove("hidden");
    adminArea.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    adminInfo.textContent = "";
    return;
  }

  // Verify Admin Role
  const adminRef = doc(db, "admins", user.uid);
  const adminSnap = await getDoc(adminRef);

  if (!adminSnap.exists()) {
    showToast("Access Denied: You do not have administrator privileges.", "error");
    await signOut(auth);
    return;
  }

  // Access Granted
  authSection.classList.add("hidden");
  adminArea.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
  adminInfo.textContent = `Admin: ${user.email}`;
  
  loadStudents();
});

// ===== DATA OPERATIONS =====
async function loadStudents() {
  tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; color:var(--text-muted);">Loading records...</td></tr>`;
  
  try {
    const snap = await getDocs(collection(db, "students"));
    tableBody.innerHTML = "";

    if (snap.empty) {
      tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">No students found.</td></tr>`;
      return;
    }

    snap.forEach(docSnap => {
      const d = docSnap.data();
      const uid = docSnap.id;
      const dueAmount = d.fees?.due ?? (Number(d.fees?.total) - Number(d.fees?.paid));

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="uid-cell" title="${uid}">${uid.substring(0,8)}...</td>
        <td><input type="text" data-field="name" data-uid="${uid}" value="${d.name || ''}" /></td>
        <td><input type="text" data-field="course" data-uid="${uid}" value="${d.course || ''}" /></td>
        <td><input type="text" data-field="branch" data-uid="${uid}" value="${d.branch || ''}" /></td>
        <td><input type="number" data-field="attendance" data-uid="${uid}" value="${d.attendance || 0}" /></td>
        <td><input type="number" data-field="total" data-uid="${uid}" value="${d.fees?.total || 0}" /></td>
        <td><input type="number" data-field="paid" data-uid="${uid}" value="${d.fees?.paid || 0}" /></td>
        <td class="due-cell">â‚¹${dueAmount.toLocaleString('en-IN')}</td>
        <td><button class="btn-success save-btn" data-uid="${uid}">Save</button></td>
      `;
      tableBody.appendChild(tr);
    });
  } catch (error) {
    showToast("Error loading student data.", "error");
    console.error(error);
  }
}

// Event Delegation for Table Buttons
tableBody.addEventListener('click', async (e) => {
  if (e.target.classList.contains('save-btn')) {
    const btn = e.target;
    const uid = btn.dataset.uid;
    const row = btn.closest('tr');
    
    // Extract inputs from this specific row
    const inputs = row.querySelectorAll('input');
    const data = {};
    inputs.forEach(input => {
      data[input.dataset.field] = input.type === 'number' ? Number(input.value) : input.value.trim();
    });

    // Validation
    if (!data.name || !data.course || !data.branch) {
      return showToast("Name, Course, and Branch are required.", "error");
    }
    if (data.attendance < 0 || data.total < 0 || data.paid < 0) {
      return showToast("Numeric values cannot be negative.", "error");
    }
    if (data.paid > data.total) {
      return showToast("Paid amount cannot exceed Total amount.", "error");
    }

    btn.innerText = "Saving...";
    btn.disabled = true;

    try {
      const ref = doc(db, "students", uid);
      const snap = await getDoc(ref);
      
      if (!snap.exists()) {
        throw new Error("Student record missing.");
      }
      
      const oldData = snap.data();
      const updated = {
        name: data.name,
        email: oldData.email || "", 
        course: data.course,
        branch: data.branch,
        attendance: data.attendance,
        clinicalHours: oldData.clinicalHours || 0,
        internshipDays: oldData.internshipDays || 0,
        assignments: oldData.assignments || 0,
        fees: {
          total: data.total,
          paid: data.paid,
          due: data.total - data.paid
        },
        createdAt: oldData.createdAt || serverTimestamp()
      };

      await setDoc(ref, updated);
      showToast(`${data.name}'s profile updated successfully.`);
      
      // Update the 'Due' cell in the UI without a full reload
      row.querySelector('.due-cell').innerText = `â‚¹${(data.total - data.paid).toLocaleString('en-IN')}`;
      
    } catch (error) {
      showToast(error.message || "Failed to save data.", "error");
    } finally {
      btn.innerText = "Save";
      btn.disabled = false;
    }
  }
});

refreshBtn.onclick = () => {
  loadStudents();
  showToast("Data refreshed.");
};

// ===== CREATE STUDENT =====
addStudentBtn.onclick = async () => {
  const uid = document.getElementById("newUid").value.trim();
  const name = document.getElementById("newName").value.trim();
  const email = document.getElementById("newEmail").value.trim();
  const course = document.getElementById("newCourse").value.trim();
  const branch = document.getElementById("newBranch").value.trim();
  const totalFee = Number(document.getElementById("newFee").value);

  if (!uid || !name || !email || !course || !branch) {
    return showToast("Please fill in all student details.", "error");
  }
  if (isNaN(totalFee) || totalFee < 0) {
    return showToast("Please enter a valid total fee.", "error");
  }

  addStudentBtn.innerText = "Creating...";
  addStudentBtn.disabled = true;

  try {
    const data = {
      name,
      email,
      course,
      branch,
      attendance: 0,
      clinicalHours: 0,
      internshipDays: 0,
      assignments: 0,
      fees: {
        total: totalFee,
        paid: 0,
        due: totalFee
      },
      createdAt: serverTimestamp()
    };

    await setDoc(doc(db, "students", uid), data);
    
    // Clear Form
    document.querySelectorAll('.form-grid input').forEach(input => input.value = '');
    showToast("New student created successfully!");
    loadStudents();

  } catch (error) {
    showToast("Failed to create student.", "error");
    console.error(error);
  } finally {
    addStudentBtn.innerText = "Create Student Record";
    addStudentBtn.disabled = false;
  }
};
</script>

</body>
</html>
