<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Student Corner | CINPS</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="CINPS Student Portal">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#0d3b8e;
  --bg:#f4f7fb;
  --shadow:0 10px 30px rgba(0,0,0,0.05);
}

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Poppins',sans-serif;background:var(--bg);}

header{
  background:var(--brand);
  color:#fff;
  padding:18px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button{
  cursor:pointer;
  border:none;
  border-radius:6px;
  padding:8px 14px;
  font-size:13px;
}

.logout-btn{
  background:#e53935;
  color:#fff;
}

.login-screen{
  min-height:90vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.login-card{
  background:#fff;
  padding:40px;
  border-radius:14px;
  box-shadow:var(--shadow);
  text-align:center;
  width:95%;
  max-width:400px;
}

.google-btn{
  width:100%;
  background:#fff;
  border:1px solid #ddd;
  padding:12px;
  border-radius:8px;
  font-weight:600;
}

.dashboard{
  display:none;
  width:95%;
  max-width:1100px;
  margin:30px auto;
}

.profile, .card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:var(--shadow);
  margin-bottom:20px;
}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:16px;
  margin-bottom:20px;
}

.stat-card{
  background:#fff;
  padding:18px;
  border-radius:12px;
  box-shadow:var(--shadow);
  text-align:center;
}

.stat-card h3{
  font-size:22px;
  color:var(--brand);
}

.fee-bar{
  height:8px;
  background:#ddd;
  border-radius:4px;
  margin-top:8px;
  overflow:hidden;
}

.fee-fill{
  height:100%;
  background:#10b981;
  width:0%;
  transition:width 0.4s ease;
}
</style>
</head>
<body>

<header>
  <h2>CINPS Student Portal</h2>
  <button id="logoutBtn" class="logout-btn" style="display:none;">Logout</button>
</header>

<div id="guestView" class="login-screen">
  <div class="login-card">
    <h2>Student Login</h2>
    <p style="margin:10px 0 20px;">Login using your registered email</p>
    <button class="google-btn" id="loginBtn">Sign in with Google</button>
  </div>
</div>

<div id="dashboard" class="dashboard">

  <div class="profile">
    <h2 id="studentName">Loading...</h2>
    <p>Email: <span id="studentEmail"></span></p>
    <p>Course: <span id="studentCourse"></span></p>
    <p>Branch: <span id="studentBranch"></span></p>
  </div>

  <div class="stats">
    <div class="stat-card">
      <h3 id="attendanceStat">0%</h3>
      <p>Attendance</p>
    </div>
    <div class="stat-card">
      <h3 id="clinicalStat">0</h3>
      <p>Clinical Hours</p>
    </div>
    <div class="stat-card">
      <h3 id="internshipStat">0</h3>
      <p>Internship Days</p>
    </div>
    <div class="stat-card">
      <h3 id="assignmentStat">0</h3>
      <p>Assignments</p>
    </div>
  </div>

  <div class="card">
    <h3>Fee Status</h3>
    <p>Total: â‚¹<span id="feeTotal">0</span></p>
    <p>Paid: â‚¹<span id="feePaid">0</span></p>
    <p>Due: â‚¹<span id="feeDue">0</span></p>
    <div class="fee-bar">
      <div id="feeFill" class="fee-fill"></div>
    </div>
  </div>

  <div class="card">
    <h3>Course Syllabus</h3>
    <div id="syllabusSection"></div>
  </div>

  <div class="card">
    <h3>Assignments</h3>
    <div id="assignmentSection"></div>
  </div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ðŸ” YOUR REAL CONFIG HERE */
const firebaseConfig = {
  apiKey: "AIzaSyA-gf_fB9JJGv4Zi6AKCFWZBT3cWAWIUhk",
  authDomain: "cinps-student-corner.firebaseapp.com",
  projectId: "cinps-student-corner",
  storageBucket: "cinps-student-corner.firebasestorage.app",
  messagingSenderId: "678888220602",
  appId: "1:678888220602:web:567b074c3e148221f5df83"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const guestView = document.getElementById("guestView");
const dashboard = document.getElementById("dashboard");

loginBtn.onclick = async () => {
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
};

logoutBtn.onclick = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    guestView.style.display = "flex";
    dashboard.style.display = "none";
    logoutBtn.style.display = "none";
    return;
  }

  guestView.style.display = "none";
  dashboard.style.display = "block";
  logoutBtn.style.display = "inline-block";

  const uid = user.uid;
  const studentRef = doc(db, "students", uid);
  const snap = await getDoc(studentRef);

  if (!snap.exists()) {
    alert("No student record found.");
    await signOut(auth);
    return;
  }

  const data = snap.data();

  document.getElementById("studentName").innerText = data.name;
  document.getElementById("studentEmail").innerText = data.email;
  document.getElementById("studentCourse").innerText = data.course;
  document.getElementById("studentBranch").innerText = data.branch;

  document.getElementById("attendanceStat").innerText = data.attendance + "%";
  document.getElementById("clinicalStat").innerText = data.clinicalHours;
  document.getElementById("internshipStat").innerText = data.internshipDays;
  document.getElementById("assignmentStat").innerText = data.assignments;

  const total = Number(data.fees?.total || 0);
  const paid = Number(data.fees?.paid || 0);
  const due = total - paid;

  document.getElementById("feeTotal").innerText = total;
  document.getElementById("feePaid").innerText = paid;
  document.getElementById("feeDue").innerText = due;

  const percent = total > 0 ? (paid / total) * 100 : 0;
  document.getElementById("feeFill").style.width = percent + "%";

  // ================= CSV LOADING =================

  async function loadCSV(path){
    const response = await fetch(path);
    const text = await response.text();
    return text.split("\n").map(r => r.split(","));
  }

  function renderList(containerId, items){
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    if(!items || items.length === 0){
      container.innerHTML = "<p>No records available.</p>";
      return;
    }

    items.forEach(item => {
      const div = document.createElement("div");
      div.style.margin = "6px 0";
      div.innerText = "ðŸ“„ " + item;
      container.appendChild(div);
    });
  }

  const courseName = data.course;

  loadCSV("/data/syllabus.csv").then(rows => {
    const filtered = rows.filter(r => r[0] === courseName).map(r => r[1]);
    renderList("syllabusSection", filtered);
  });

  loadCSV("/data/assignments.csv").then(rows => {
    const filtered = rows.filter(r => r[0] === courseName).map(r => r[1]);
    renderList("assignmentSection", filtered);
  });

});

</script>
</body>
</html>
