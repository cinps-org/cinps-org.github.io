<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Student Corner | CINPS</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="description" content="CINPS Student Portal Dashboard">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* --- Design System & Branding --- */
:root {
  --brand-primary: #0d3b8e;     /* CINPS Deep Blue */
  --brand-secondary: #1e5dd6;   /* Lighter Blue for hover states */
  --accent: #f0b323;            /* Amber for attention */
  --success: #10b981;           /* Green for positive stats */
  --danger: #e53935;            /* Red for alerts/logout */
  --bg-color: #f4f7fb;          /* Soft gray/blue background */
  --card-bg: #ffffff;
  --text-main: #333333;
  --text-muted: #6b7280;
  --border-color: #e5e7eb;
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
  --shadow-md: 0 8px 16px rgba(13, 59, 142, 0.08);
  --radius-lg: 16px;
  --radius-md: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background-color: var(--bg-color);
  color: var(--text-main);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
}

/* --- Header --- */
header {
  background: var(--brand-primary);
  color: #fff;
  padding: 16px 5%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 0;
  z-index: 100;
}

header h2 {
  font-size: 1.25rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

button {
  cursor: pointer;
  border: none;
  border-radius: var(--radius-md);
  padding: 10px 18px;
  font-size: 0.875rem;
  font-weight: 500;
  font-family: inherit;
  transition: all 0.2s ease;
}

.logout-btn {
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.logout-btn:hover {
  background: var(--danger);
  border-color: var(--danger);
}

/* --- Login Screen --- */
.login-screen {
  min-height: calc(100vh - 65px);
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.login-card {
  background: var(--card-bg);
  padding: 40px 30px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  text-align: center;
  width: 100%;
  max-width: 420px;
}

.login-card h2 {
  color: var(--brand-primary);
  margin-bottom: 8px;
}

.login-card p {
  color: var(--text-muted);
  margin-bottom: 24px;
  font-size: 0.95rem;
}

.google-btn {
  width: 100%;
  background: #fff;
  color: var(--text-main);
  border: 1px solid var(--border-color);
  padding: 12px;
  border-radius: var(--radius-md);
  font-weight: 600;
  font-size: 1rem;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow-sm);
}

.google-btn:hover { background: #f9fafb; border-color: #d1d5db; }

/* --- Dashboard Layout --- */
.dashboard {
  display: none;
  width: 92%;
  max-width: 1200px;
  margin: 30px auto;
  gap: 20px;
}

/* --- Cards --- */
.card, .profile {
  background: var(--card-bg);
  padding: 24px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  margin-bottom: 20px;
  border: 1px solid rgba(0,0,0,0.02);
}

.card h3 {
  color: var(--brand-primary);
  margin-bottom: 16px;
  font-size: 1.15rem;
  border-bottom: 2px solid var(--bg-color);
  padding-bottom: 10px;
}

/* --- Profile Section --- */
.profile-header {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.profile h2 {
  color: var(--brand-primary);
  font-size: 1.5rem;
  margin-bottom: 12px;
}

.profile-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  background: var(--bg-color);
  padding: 16px;
  border-radius: var(--radius-md);
}

.profile-details p {
  font-size: 0.9rem;
  color: var(--text-muted);
}
.profile-details span {
  font-weight: 600;
  color: var(--text-main);
  display: block;
  margin-top: 2px;
}

/* --- Stats Grid --- */
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--card-bg);
  padding: 20px 15px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  text-align: center;
  border-bottom: 4px solid var(--brand-primary);
}

.stat-card:nth-child(1) { border-color: var(--success); }
.stat-card:nth-child(2) { border-color: #3b82f6; }
.stat-card:nth-child(3) { border-color: #8b5cf6; }
.stat-card:nth-child(4) { border-color: var(--accent); }

.stat-card h3 {
  font-size: 1.75rem;
  color: var(--text-main);
  margin-bottom: 4px;
}

.stat-card p {
  font-size: 0.85rem;
  color: var(--text-muted);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* --- Fee Bar --- */
.fee-grid {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  font-size: 0.95rem;
}

.fee-bar {
  height: 10px;
  background: var(--border-color);
  border-radius: 5px;
  overflow: hidden;
}

.fee-fill {
  height: 100%;
  background: var(--success);
  width: 0%;
  transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

/* --- Lists (Syllabus/Assignments) --- */
.list-item {
  background: var(--bg-color);
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* --- Form Styles --- */
.form-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

@media (min-width: 600px) {
  .form-grid { grid-template-columns: 1fr 1fr; }
  .form-full-width { grid-column: 1 / -1; }
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-muted);
}

input[type="time"], select {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.95rem;
  background-color: #fff;
  color: var(--text-main);
  transition: border-color 0.2s;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--brand-primary);
  box-shadow: 0 0 0 3px rgba(13, 59, 142, 0.1);
}

button[type="submit"] {
  background: var(--brand-primary);
  color: #fff;
  padding: 14px;
  font-size: 1rem;
  width: 100%;
  margin-top: 10px;
  box-shadow: 0 4px 6px rgba(13, 59, 142, 0.2);
}

button[type="submit"]:hover { background: var(--brand-secondary); }

#updateStatus {
  text-align: center;
  font-size: 0.9rem;
  font-weight: 500;
  margin-top: 12px;
}

/* --- Mobile Adjustments --- */
@media (max-width: 480px) {
  header { padding: 16px 20px; }
  header h2 { font-size: 1.1rem; }
  .dashboard { width: 95%; margin: 20px auto; }
  .card, .profile { padding: 20px 16px; }
  .stats { grid-template-columns: repeat(2, 1fr); gap: 12px; }
  .stat-card h3 { font-size: 1.5rem; }
  .fee-grid { flex-direction: column; gap: 4px; }
}
</style>
</head>
<body>

<header>
  <h2>CINPS Portal</h2>
  <button id="logoutBtn" class="logout-btn" style="display:none;">Logout</button>
</header>

<div id="guestView" class="login-screen">
  <div class="login-card">
    <h2>Welcome Student</h2>
    <p>Access your academics, clinical hours, and fees securely.</p>
    <button class="google-btn" id="loginBtn">
      <svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Sign in with Google
    </button>
  </div>
</div>

<div id="dashboard" class="dashboard">

  <div class="profile">
    <div class="profile-header">
      <h2 id="studentName">Loading...</h2>
    </div>
    <div class="profile-details">
      <p>Email: <span id="studentEmail">...</span></p>
      <p>Course: <span id="studentCourse">...</span></p>
      <p>Branch: <span id="studentBranch">...</span></p>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <h3 id="attendanceStat">0%</h3>
      <p>Attendance</p>
    </div>
    <div class="stat-card">
      <h3 id="clinicalStat">0</h3>
      <p>Clinical Hrs</p>
    </div>
    <div class="stat-card">
      <h3 id="internshipStat">0</h3>
      <p>Internship</p>
    </div>
    <div class="stat-card">
      <h3 id="assignmentStat">0</h3>
      <p>Tasks Due</p>
    </div>
  </div>

  <div class="card">
    <h3>Fee Status</h3>
    <div class="fee-grid">
      <p style="color:var(--text-muted)">Total: <strong style="color:var(--text-main)">â‚¹<span id="feeTotal">0</span></strong></p>
      <p style="color:var(--success)">Paid: <strong>â‚¹<span id="feePaid">0</span></strong></p>
      <p style="color:var(--danger)">Due: <strong>â‚¹<span id="feeDue">0</span></strong></p>
    </div>
    <div class="fee-bar">
      <div id="feeFill" class="fee-fill"></div>
    </div>
  </div>

  <div class="card">
    <h3>Student Class Update</h3>
    <form id="studentUpdateForm" class="form-grid">
      
      <div class="input-group">
        <label>Class Start Time</label>
        <input type="time" name="startTime" required>
      </div>

      <div class="input-group">
        <label>Branch</label>
        <select name="branch" required>
          <option value="">Select Branch</option>
          <option>Nanoor</option>
          <option>Sainthia</option>
          <option>Other</option>
        </select>
      </div>

      <div class="input-group">
        <label>Course</label>
        <select name="course" required>
          <option value="">Select Course</option>
          <option>OTT</option>
          <option>MLT</option>
          <option>EMT</option>
          <option>ICU</option>
          <option>MRT</option>
          <option>ECG</option>
          <option>PT</option>
          <option>RMP</option>
          <option>CMS & ED</option>
          <option>NA</option>
        </select>
      </div>

      <div class="input-group">
        <label>Year</label>
        <select name="year" required>
          <option value="">Select Year</option>
          <option>First Year</option>
          <option>Second Year</option>
        </select>
      </div>

      <div class="input-group">
        <label>Class Type</label>
        <select name="classType" required>
          <option value="">Select Type</option>
          <option>Theory</option>
          <option>Practical</option>
          <option>Other</option>
        </select>
      </div>

      <div class="input-group">
        <label>Class Review</label>
        <select name="review" required>
          <option value="">Select Review</option>
          <option>Good</option>
          <option>Medium</option>
          <option>Bad</option>
        </select>
      </div>

      <div class="input-group form-full-width">
        <button type="submit">Submit Class Update</button>
        <div id="updateStatus"></div>
      </div>

    </form>
  </div>

  <div class="card">
    <h3>Course Syllabus</h3>
    <div id="syllabusSection"></div>
  </div>

  <div class="card">
    <h3>Recent Assignments</h3>
    <div id="assignmentSection"></div>
  </div>

</div>

<script type="module">
// ===== FIREBASE IMPORTS =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ðŸ” PASTE YOUR REAL KEYS HERE */
const firebaseConfig = {
 apiKey: "AIzaSyA-gf_fB9JJGv4Zi6AKCFWZBT3cWAWIUhk",
  authDomain: "cinps-student-corner.firebaseapp.com",
  projectId: "cinps-student-corner",
  storageBucket: "cinps-student-corner.firebasestorage.app",
  messagingSenderId: "678888220602",
  appId: "1:678888220602:web:567b074c3e148221f5df83"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===== UI ELEMENTS =====
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const guestView = document.getElementById("guestView");
const dashboard = document.getElementById("dashboard");

// ===== AUTHENTICATION =====
loginBtn.onclick = async () => {
  const provider = new GoogleAuthProvider();
  try {
    await signInWithPopup(auth, provider);
  } catch (error) {
    console.error("Login failed", error);
    alert("Login failed. Please try again.");
  }
};

logoutBtn.onclick = async () => {
  await signOut(auth);
};

// ===== AUTH STATE OBSERVER & FIRESTORE FETCH =====
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    guestView.style.display = "flex";
    dashboard.style.display = "none";
    logoutBtn.style.display = "none";
    return;
  }

  guestView.style.display = "none";
  dashboard.style.display = "flex";
  dashboard.style.flexDirection = "column"; // Ensure proper stacking
  logoutBtn.style.display = "inline-block";

  // IMPORTANT: Strict Firestore UID checking maintained
  const uid = user.uid;
  const studentRef = doc(db, "students", uid);
  const snap = await getDoc(studentRef);

  if (!snap.exists()) {
    alert("No student record found for this email. Please contact administration.");
    await signOut(auth);
    return;
  }

  const data = snap.data();

  // Populate Profile
  document.getElementById("studentName").innerText = data.name || "Student";
  document.getElementById("studentEmail").innerText = data.email || user.email;
  document.getElementById("studentCourse").innerText = data.course || "N/A";
  document.getElementById("studentBranch").innerText = data.branch || "N/A";

  // Populate Stats
  document.getElementById("attendanceStat").innerText = (data.attendance || 0) + "%";
  document.getElementById("clinicalStat").innerText = data.clinicalHours || 0;
  document.getElementById("internshipStat").innerText = data.internshipDays || 0;
  document.getElementById("assignmentStat").innerText = data.assignments || 0;

  // Populate Fees
  const total = Number(data.fees?.total || 0);
  const paid = Number(data.fees?.paid || 0);
  const due = total - paid;

  document.getElementById("feeTotal").innerText = total.toLocaleString('en-IN');
  document.getElementById("feePaid").innerText = paid.toLocaleString('en-IN');
  document.getElementById("feeDue").innerText = due.toLocaleString('en-IN');

  // Animate Fee Bar
  setTimeout(() => {
    const percent = total > 0 ? (paid / total) * 100 : 0;
    document.getElementById("feeFill").style.width = Math.min(percent, 100) + "%";
  }, 300); // Slight delay for animation effect

  // ===== GOOGLE SCRIPT FORM SUBMISSION =====
  const updateScriptURL = "PASTE_YOUR_EXISTING_GOOGLE_SCRIPT_URL_HERE";
  const studentUpdateForm = document.getElementById("studentUpdateForm");

  // Remove existing listeners to prevent duplicates on auth state change
  const newForm = studentUpdateForm.cloneNode(true);
  studentUpdateForm.parentNode.replaceChild(newForm, studentUpdateForm);

  newForm.addEventListener("submit", e => {
    e.preventDefault();
    const status = document.getElementById("updateStatus");
    status.style.color = "var(--brand-primary)";
    status.innerText = "Submitting securely...";

    // Optionally attach the UID to the form data so your backend knows exactly who submitted
    const formData = new FormData(newForm);
    formData.append("uid", uid); 
    formData.append("studentEmail", user.email);

    fetch(updateScriptURL, {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(() => {
      status.style.color = "var(--success)";
      status.innerText = "âœ… Update submitted successfully";
      newForm.reset();
      setTimeout(() => status.innerText = "", 3000);
    })
    .catch(() => {
      status.style.color = "var(--danger)";
      status.innerText = "âŒ Submission failed. Please try again.";
    });
  });

  // ===== CSV LOADING LOGIC =====
  async function loadCSV(path){
    try {
      const response = await fetch(path);
      if(!response.ok) return [];
      const text = await response.text();
      return text.split("\n").map(r => r.split(","));
    } catch (e) {
      console.error("Error loading CSV:", e);
      return [];
    }
  }

  function renderList(containerId, items){
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    if(!items || items.length === 0){
      container.innerHTML = '<p style="color:var(--text-muted);font-size:0.9rem;">No records available at the moment.</p>';
      return;
    }

    items.forEach(item => {
      if(item && item.trim() !== "") {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `<span>ðŸ“„</span> <span>${item}</span>`;
        container.appendChild(div);
      }
    });
  }

  const courseName = (data.course || "").trim();

  // Load Syllabus & Assignments
  if(courseName) {
    loadCSV("/data/syllabus.csv").then(rows => {
      const filtered = rows
        .filter(r => r[0] && r[0].trim() === courseName)
        .map(r => r[1]);
      renderList("syllabusSection", filtered);
    });

    loadCSV("/data/assignments.csv").then(rows => {
      const filtered = rows
        .filter(r => r[0] && r[0].trim() === courseName)
        .map(r => r[1]);
      renderList("assignmentSection", filtered);
    });
  } else {
     renderList("syllabusSection", []);
     renderList("assignmentSection", []);
  }

});
</script>
</body>
</html>
