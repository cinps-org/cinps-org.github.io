<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>CINPS Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:20px; }
h1 { margin-top:0; }
button { padding:6px 10px; cursor:pointer; }
table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; }
th, td { border:1px solid #ddd; padding:8px; text-align:left; }
th { background:#eee; }
.hidden { display:none; }
.card { background:#fff; padding:15px; margin-top:20px; }
input { padding:5px; margin:2px 0; width:100%; }
.small-input { width:70px; }
.status { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<h1>CINPS Admin Panel</h1>

<div id="authSection">
  <button id="loginBtn">Sign in with Google</button>
  <button id="logoutBtn" class="hidden">Logout</button>
  <div id="adminInfo" class="status"></div>
</div>

<div id="adminArea" class="hidden">

  <div class="card">
    <h3>Add / Create Student (UID Based)</h3>
    <input id="studentUid" placeholder="Student UID (from Auth)" />
    <input id="name" placeholder="Name" />
    <input id="email" placeholder="Email" />
    <input id="course" placeholder="Course" />
    <input id="branch" placeholder="Branch" />
    <input id="feeTotal" type="number" placeholder="Total Fee" />
    <button id="addStudentBtn">Create Student</button>
    <div id="formStatus" class="status"></div>
  </div>

  <div class="card">
    <h3>Students</h3>
    <table>
      <thead>
        <tr>
          <th>UID</th>
          <th>Name</th>
          <th>Course</th>
          <th>Branch</th>
          <th>Attendance</th>
          <th>Fee Due</th>
          <th>Add Attendance</th>
          <th>Add Payment</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody id="studentsTable"></tbody>
    </table>
  </div>

</div>

<script type="module">
import { auth, provider, db } from "./firebase-init.js";
import {
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

import {
  doc,
  getDoc,
  setDoc,
  collection,
  getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const adminArea = document.getElementById("adminArea");
const adminInfo = document.getElementById("adminInfo");
const formStatus = document.getElementById("formStatus");
const tableBody = document.getElementById("studentsTable");
const addBtn = document.getElementById("addStudentBtn");

loginBtn.onclick = () => signInWithPopup(auth, provider);
logoutBtn.onclick = () => signOut(auth);

onAuthStateChanged(auth, async (user) => {

  if (!user) {
    loginBtn.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
    adminArea.classList.add("hidden");
    adminInfo.textContent = "";
    return;
  }

  try {
    const adminRef = doc(db, "admins", user.uid);
    const adminSnap = await getDoc(adminRef);

    if (!adminSnap.exists()) {
      alert("Access denied: Not an admin");
      await signOut(auth);
      return;
    }

    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    adminArea.classList.remove("hidden");
    adminInfo.textContent = "Logged in as: " + user.email;

    loadStudents();

  } catch (error) {
    alert("Permission error. Check Firestore rules.");
    await signOut(auth);
  }
});

async function loadStudents() {
  tableBody.innerHTML = "";
  const snap = await getDocs(collection(db, "students"));

  snap.forEach(docSnap => {
    const d = docSnap.data();
    const uid = docSnap.id;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${uid}</td>
      <td>${d.name}</td>
      <td>${d.course}</td>
      <td>${d.branch}</td>
      <td>${d.attendance}</td>
      <td>${d.fees?.due}</td>

      <td>
        <input type="number" min="0" class="small-input" id="att-${uid}">
      </td>

      <td>
        <input type="number" min="0" class="small-input" id="pay-${uid}">
      </td>

      <td>
        <button onclick="updateStudent('${uid}')">Save</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

window.updateStudent = async function(uid) {

  const ref = doc(db, "students", uid);
  const snap = await getDoc(ref);

  if (!snap.exists()) return alert("Student not found");

  const data = snap.data();

  const addAttendance = Number(document.getElementById("att-" + uid).value || 0);
  const addPayment = Number(document.getElementById("pay-" + uid).value || 0);

  if (addAttendance < 0 || addPayment < 0) {
    return alert("Negative values not allowed");
  }

  const newAttendance = data.attendance + addAttendance;
  const newPaid = data.fees.paid + addPayment;
  const total = data.fees.total;

  if (newPaid > total) {
    return alert("Payment exceeds total fee");
  }

  const updated = {
    name: data.name,
    email: data.email,
    course: data.course,
    branch: data.branch,
    attendance: newAttendance,
    clinicalHours: data.clinicalHours,
    internshipDays: data.internshipDays,
    assignments: data.assignments,
    fees: {
      total: total,
      paid: newPaid,
      due: total - newPaid
    },
    createdAt: data.createdAt
  };

  await setDoc(ref, updated);
  alert("Student updated");
  loadStudents();
};

addBtn.onclick = async () => {

  const uid = document.getElementById("studentUid").value.trim();
  const name = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim();
  const course = document.getElementById("course").value.trim();
  const branch = document.getElementById("branch").value.trim();
  const totalFee = Number(document.getElementById("feeTotal").value);

  if (!uid || !name || !email || !course || !branch) {
    formStatus.textContent = "All fields required.";
    return;
  }

  if (isNaN(totalFee) || totalFee < 0) {
    formStatus.textContent = "Invalid fee amount.";
    return;
  }

  const data = {
    name,
    email,
    course,
    branch,
    attendance: 0,
    clinicalHours: 0,
    internshipDays: 0,
    assignments: 0,
    fees: {
      total: totalFee,
      paid: 0,
      due: totalFee
    },
    createdAt: serverTimestamp()
  };

  await setDoc(doc(db, "students", uid), data);
  formStatus.textContent = "Student created successfully.";
  loadStudents();
};
</script>

</body>
</html>
