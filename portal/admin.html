<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CINPS Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background:#f5f6fa; margin:0; padding:20px; }
    h1 { margin-top:0; }
    button { padding:8px 12px; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#eee; }
    .hidden { display:none; }
    .card { background:#fff; padding:15px; margin-top:20px; }
    input { padding:6px; margin:4px 0; width:100%; }
  </style>
</head>
<body>

<h1>CINPS Admin Panel</h1>

<button id="loginBtn">Sign in with Google</button>
<button id="logoutBtn" class="hidden">Logout</button>

<div id="adminArea" class="hidden">

  <div class="card">
    <h3>Add Student (UID Based)</h3>
    <input id="studentUid" placeholder="Student UID (from Auth)" />
    <input id="name" placeholder="Name" />
    <input id="email" placeholder="Email" />
    <input id="course" placeholder="Course" />
    <input id="branch" placeholder="Branch" />
    <input id="feeTotal" type="number" placeholder="Total Fee" />
    <button id="addStudentBtn">Create / Update Student</button>
  </div>

  <div class="card">
    <h3>Students</h3>
    <table>
      <thead>
        <tr>
          <th>UID</th>
          <th>Name</th>
          <th>Course</th>
          <th>Branch</th>
          <th>Attendance</th>
          <th>Fee Due</th>
        </tr>
      </thead>
      <tbody id="studentsTable"></tbody>
    </table>
  </div>

</div>

<script type="module">
  import { auth, provider, db } from "./firebase-init.js";
  import {
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

  import {
    doc, getDoc, setDoc, collection, getDocs, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const adminArea = document.getElementById("adminArea");
  const tableBody = document.getElementById("studentsTable");

  loginBtn.onclick = () => signInWithPopup(auth, provider);
  logoutBtn.onclick = () => signOut(auth);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      loginBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
      adminArea.classList.add("hidden");
      return;
    }

    // Verify admin
    const adminRef = doc(db, "admins", user.uid);
    const adminSnap = await getDoc(adminRef);

    if (!adminSnap.exists()) {
      alert("Access denied: Not an admin");
      await signOut(auth);
      return;
    }

    loginBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    adminArea.classList.remove("hidden");

    loadStudents();
  });

  async function loadStudents() {
    tableBody.innerHTML = "";
    const snap = await getDocs(collection(db, "students"));
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${docSnap.id}</td>
        <td>${d.name}</td>
        <td>${d.course}</td>
        <td>${d.branch}</td>
        <td>${d.attendance}</td>
        <td>${d.fees?.due}</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  document.getElementById("addStudentBtn").onclick = async () => {
    const uid = document.getElementById("studentUid").value.trim();
    if (!uid) return alert("Student UID required");

    const data = {
      name: document.getElementById("name").value,
      email: document.getElementById("email").value,
      course: document.getElementById("course").value,
      branch: document.getElementById("branch").value,
      attendance: 0,
      clinicalHours: 0,
      internshipDays: 0,
      assignments: 0,
      fees: {
        total: Number(document.getElementById("feeTotal").value),
        paid: 0,
        due: Number(document.getElementById("feeTotal").value)
      },
      createdAt: serverTimestamp()
    };

    await setDoc(doc(db, "students", uid), data, { merge: true });
    alert("Student saved");
    loadStudents();
  };
</script>

</body>
</html>
