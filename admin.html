<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CINPS Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:'Poppins',sans-serif;background:#f4f7fb;}
header{background:#0d3b8e;color:#fff;padding:18px 30px;display:flex;justify-content:space-between;align-items:center;}
.dashboard{width:95%;max-width:1200px;margin:30px auto;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}
.stat-card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,0.05);}
.stat-card h3{margin:0;font-size:22px;color:#0d3b8e;}
.stat-card p{margin:5px 0 0;font-size:13px;color:#666;}
.card{background:#fff;padding:20px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,0.05);}
table{width:100%;border-collapse:collapse;}
th,td{padding:12px;border-bottom:1px solid #eee;font-size:13px;}
th{background:#f0f4ff;text-align:left;}
button{padding:6px 12px;border:none;border-radius:6px;font-size:12px;cursor:pointer;}
.edit{background:#0d3b8e;color:#fff;}
.logout{background:#ef4444;color:#fff;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);justify-content:center;align-items:center;z-index:1000;}
.modal{background:#fff;width:95%;max-width:500px;padding:25px;border-radius:12px;}
.form-group{display:flex;flex-direction:column;gap:5px;}
.form-group label{font-size:12px;font-weight:600;}
.modal input,.modal select{padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px;}
</style>
</head>

<body>

<div id="loading-screen" style="padding:100px;text-align:center;">
  <h2>Checking Admin Access...</h2>
</div>

<div id="admin-content" style="display:none;">

<header>
  <h2>CINPS Admin Dashboard</h2>
  <button class="logout" onclick="logout()">Log Out</button>
</header>

<div class="dashboard">

<div class="stats">
  <div class="stat-card"><h3 id="totalStudents">0</h3><p>Total Students</p></div>
  <div class="stat-card"><h3 id="totalCollected">₹0</h3><p>Total Fee Collected</p></div>
  <div class="stat-card"><h3 id="totalPending">₹0</h3><p>Total Pending Fees</p></div>
</div>

<div class="card">

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
  <h3>Student Records</h3>
  <button class="edit" onclick="openCreateModal()">+ Add Student</button>
</div>

<table>
<thead>
<tr>
<th>Name</th>
<th>Course</th>
<th>Attendance</th>
<th>Fee Paid</th>
<th>Fee Total</th>
<th>Edit</th>
</tr>
</thead>
<tbody id="studentTable"></tbody>
</table>

</div>
</div>
</div>

<!-- CREATE MODAL -->
<div id="createModal" class="modal-overlay">
<div class="modal">
<h3>Create Student</h3>

<div class="form-group">
<label>Name</label>
<input id="createName">
</div>

<div class="form-group">
<label>Email (Document ID)</label>
<input id="createEmail">
</div>

<div class="form-group">
<label>Course</label>
<input id="createCourse">
</div>

<div class="form-group">
<label>Total Fee</label>
<input id="createTotal" type="number">
</div>

<div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end;">
<button onclick="closeCreateModal()">Cancel</button>
<button class="edit" onclick="createStudent()">Create</button>
</div>

</div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal-overlay">
<div class="modal">

<h3>Edit Student</h3>

<input type="hidden" id="editEmail">

<div class="form-group">
<label>Name</label>
<input id="editName">
</div>

<div class="form-group">
<label>Course</label>
<input id="editCourse">
</div>

<div class="form-group">
<label>Attendance (%)</label>
<input id="editAttendance" type="number">
</div>

<div class="form-group">
<label>Fee Paid</label>
<input id="editPaid" type="number">
</div>

<div class="form-group">
<label>Fee Total</label>
<input id="editTotal" type="number">
</div>

<div style="margin-top:15px;display:flex;gap:10px;justify-content:flex-end;">
<button onclick="closeEditModal()">Cancel</button>
<button class="edit" onclick="saveEdit()">Save</button>
</div>

</div>
</div>

<script type="module">

import { auth } from "./firebase/firebase-auth.js";
import { db } from "./firebase/firebase-firestore.js";
import { onAuthStateChanged, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import { 
doc, getDoc, collection, onSnapshot, 
updateDoc, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const studentTable = document.getElementById("studentTable");
const totalStudents = document.getElementById("totalStudents");
const totalCollected = document.getElementById("totalCollected");
const totalPending = document.getElementById("totalPending");

onAuthStateChanged(auth, async (user)=>{

if(!user){ window.location.href="student-corner.html"; return; }

const adminSnap = await getDoc(doc(db,"admins",user.uid));
if(!adminSnap.exists()){ window.location.href="student-corner.html"; return; }

document.getElementById("loading-screen").style.display="none";
document.getElementById("admin-content").style.display="block";

onSnapshot(collection(db,"students"), snapshot=>{

let count=0, collected=0, pending=0;
studentTable.innerHTML="";

snapshot.forEach(docSnap=>{

const data = docSnap.data();
const email = docSnap.id;

const total = data.fees?.total || 0;
const paid = data.fees?.paid || 0;

count++;
collected+=paid;
pending+=(total-paid);

studentTable.innerHTML+=`
<tr>
<td>${data.name}</td>
<td>${data.course}</td>
<td>${data.attendance||0}%</td>
<td>₹${paid}</td>
<td>₹${total}</td>
<td><button class="edit" onclick="openEdit('${email}')">Edit</button></td>
</tr>
`;

});

totalStudents.textContent=count;
totalCollected.textContent="₹"+collected;
totalPending.textContent="₹"+pending;

});

});

/* CREATE */

window.openCreateModal=()=>document.getElementById("createModal").style.display="flex";
window.closeCreateModal=()=>document.getElementById("createModal").style.display="none";

window.createStudent=async()=>{

const name=createName.value.trim();
const email=createEmail.value.trim().toLowerCase();
const course=createCourse.value.trim();
const total=Number(createTotal.value)||0;

if(!name||!email){ alert("Name & Email required"); return; }

await setDoc(doc(db,"students",email),{
uid:"",
name,
email,
course,
attendance:0,
clinicalHours:0,
internshipDays:0,
assignments:0,
fees:{ total, paid:0, due:total },
status:"pending_activation",
createdAt:serverTimestamp(),
updatedAt:serverTimestamp()
});

closeCreateModal();
};

/* EDIT */

window.openEdit=async(email)=>{

const snap=await getDoc(doc(db,"students",email));
if(!snap.exists())return;

const data=snap.data();

editEmail.value=email;
editName.value=data.name;
editCourse.value=data.course;
editAttendance.value=data.attendance||0;
editPaid.value=data.fees?.paid||0;
editTotal.value=data.fees?.total||0;

document.getElementById("editModal").style.display="flex";
};

window.closeEditModal=()=>document.getElementById("editModal").style.display="none";

window.saveEdit=async()=>{

const email=editEmail.value;

await updateDoc(doc(db,"students",email),{
name:editName.value,
course:editCourse.value,
attendance:Number(editAttendance.value),
"fees.paid":Number(editPaid.value),
"fees.total":Number(editTotal.value),
updatedAt:serverTimestamp()
});

closeEditModal();
};

window.logout=async()=>{
await signOut(auth);
window.location.href="student-corner.html";
};

</script>

</body>
</html>
