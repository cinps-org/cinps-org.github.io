<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Student Corner | CINPS</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="CINPS Student Portal - Track attendance, fees, clinical hours, and assignments.">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --brand:#0d3b8e;
  --bg:#f4f7fb;
  --shadow:0 10px 30px rgba(0,0,0,0.05);
}

*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Poppins',sans-serif;background:var(--bg);}

header{
  background:var(--brand);
  color:#fff;
  padding:18px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

button{
  cursor:pointer;
  border:none;
  border-radius:6px;
  padding:8px 14px;
  font-size:13px;
}

.login-screen{
  min-height:90vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.login-card{
  background:#fff;
  padding:40px;
  border-radius:14px;
  box-shadow:var(--shadow);
  text-align:center;
  width:95%;
  max-width:400px;
}

.google-btn{
  width:100%;
  background:#fff;
  border:1px solid #ddd;
  padding:12px;
  border-radius:8px;
  font-weight:600;
}

.dashboard{
  display:none;
  width:95%;
  max-width:1100px;
  margin:30px auto;
}

.profile{
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:var(--shadow);
  margin-bottom:20px;
}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:16px;
  margin-bottom:20px;
}

.stat-card{
  background:#fff;
  padding:18px;
  border-radius:12px;
  box-shadow:var(--shadow);
  text-align:center;
}

.stat-card h3{
  color:var(--brand);
  font-size:22px;
}

.card{
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:var(--shadow);
}

.fee-bar{
  height:8px;
  background:#ddd;
  border-radius:4px;
  margin-top:8px;
  overflow:hidden;
}

.fee-fill{
  height:100%;
  background:#10b981;
  width:0%;
}
</style>
</head>
<body>

<header>
  <h2>CINPS Student Portal</h2>
  <button onclick="handleLogout()">Logout</button>
</header>

<div id="guestView" class="login-screen">
  <div class="login-card">
    <h2>Student Login</h2>
    <p style="margin:10px 0 20px;">Login using your registered email</p>
    <button class="google-btn" onclick="handleLogin()">
      Sign in with Google
    </button>
  </div>
</div>

<div id="dashboard" class="dashboard">

  <div class="profile">
    <h2 id="studentName">Loading...</h2>
    <p>ID: <span id="studentId"></span></p>
    <p>Course: <span id="studentCourse"></span></p>
    <p>Status: <span id="studentStatus"></span></p>
    <p>Branch: <span id="studentBranch"></span></p>
  </div>

  <div class="stats">
    <div class="stat-card">
      <h3 id="attendanceStat">0%</h3>
      <p>Attendance</p>
    </div>
    <div class="stat-card">
      <h3 id="clinicalStat">0</h3>
      <p>Clinical Hours</p>
    </div>
    <div class="stat-card">
      <h3 id="internshipStat">0</h3>
      <p>Internship Days</p>
    </div>
    <div class="stat-card">
      <h3 id="assignmentStat">0</h3>
      <p>Assignments</p>
    </div>
  </div>

  <div class="card">
    <h3>Fee Status</h3>
    <p>Paid: ₹<span id="feePaid">0</span></p>
    <p>Total: ₹<span id="feeTotal">0</span></p>
    <p>Due: ₹<span id="feeDue">0</span></p>
    <div class="fee-bar">
      <div id="feeFill" class="fee-fill"></div>
    </div>
  </div>

</div>

<script type="module">

import { auth, googleProvider } from "./firebase/firebase-auth.js";
import { db } from "./firebase/firebase-firestore.js";

import { 
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const guestView = document.getElementById("guestView");
const dashboard = document.getElementById("dashboard");

window.handleLogin = async function(){
  await signInWithPopup(auth, googleProvider);
};

window.handleLogout = async function(){
  await signOut(auth);
};

onAuthStateChanged(auth, async (user)=>{

  if(!user){
    guestView.style.display="flex";
    dashboard.style.display="none";
    return;
  }

  try{

    const studentRef = doc(db,"students", user.email);
    const studentSnap = await getDoc(studentRef);

    if(!studentSnap.exists()){
      alert("No student record found. Contact administration.");
      await signOut(auth);
      return;
    }

    const studentData = studentSnap.data();

    loadDashboard(studentData);

    guestView.style.display="none";
    dashboard.style.display="block";

  }catch(error){
    console.error("FULL ERROR:", error);
    alert(error.message);
  }

});

function loadDashboard(student){

  document.getElementById("studentName").innerText = student.name || "";
  document.getElementById("studentId").innerText = student.studentId || "";
  document.getElementById("studentCourse").innerText = student.course || "";
  document.getElementById("studentStatus").innerText = student.status || "";
  document.getElementById("studentBranch").innerText = student.branch || "";

  document.getElementById("attendanceStat").innerText =
    (student.attendance || 0) + "%";

  document.getElementById("clinicalStat").innerText =
    student.clinicalHours || 0;

  document.getElementById("internshipStat").innerText =
    student.internshipDays || 0;

  document.getElementById("assignmentStat").innerText =
    student.assignments || 0;

const total = Number(student.fees?.total || 0);
const paid = Number(student.fees?.paid || 0);

// Always calculate due dynamically
const due = total - paid;

document.getElementById("feeTotal").innerText = total;
document.getElementById("feePaid").innerText = paid;
document.getElementById("feeDue").innerText = due;

const percent = total > 0 ? (paid / total) * 100 : 0;
document.getElementById("feeFill").style.width = percent + "%";

}

</script>
</body>
</html>
